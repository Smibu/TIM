{% set editline = '' %}
{%- if item.rights.editable or item.rights.can_comment -%}
    {%- set editline = '<div class="editline" title="Click to edit this paragraph"></div>' -%}
{%- endif -%}

{# TODO This template list should not be here! #}
{%- if route == "view" and text|length == 0 and item.rights.editable -%}
    <script>
        var templates = true;
    </script>
    <script src="{{ url_for('static', filename='scripts/timApp.js') }}"></script>
    <div class="par"
         id="null"
         t=""
         attrs="{}">
        <div class="parContent">
            <p>Click left side to edit. You can get help with editing from editor's Help tab.</p>
            <p>This is an automatically added help paragraph. It will disappear when you add content.</p>
        </div>
        <div ng-controller="IndexCtrl" class="index">
            <div ng-if="templateList.length">
                <div class="parContent">
                    <p>You may also choose to use one of the templates below.</p>
                </div>
                <br>
                <table>
                    <thead>
                        <tr>
                            <td>
                                <b>Template name</b>
                            </td>
                            <td></td>
                        </tr>
                    </thead>
                    <tr ng-repeat="template in templateList">
                        <td>
                            {{ '{{ template.name }}' }}
                        </td>
                        <td>
                            <button class="timButton" ng-click="copyDocument({{ item.id }}, template.path)">Load</button>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        {{ editline | safe }}
    </div>
{%- endif -%}

{%- macro start_area(t, areas, attrs) -%}
    {% set area_name = areas|join('_') %}
    <div class="area {{ t.collapsed }}area_{{areas|join(' area_')}}"
         data-doc-id="{{ t.doc_id }}">
        <div class="areaContent">
            {{ caller() }}
{%- endmacro -%}

{%- macro end_area(open_areas) -%}
    </div>
    {% if item.rights.editable or item.rights.can_comment %}
        {% for area in open_areas %}
            {% if open_areas[area] <= 3 %}
                <div class="areaeditline areaeditline{{ open_areas[area] }}"
                     title="Click to edit this area reference ({{ area }})"
                     data-area="{{ area }}">
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
    </div>
    {{ caller() }}
{%- endmacro -%}

{%- for t in text -%}
    {%- if t.end_areas -%}
        {% call end_area(t.end_areas) %}
        {% endcall %}

    {%- elif t.start_areas -%}
        {% if t.ref_attrs and t.ref_attrs.area %}
            {% call start_area(t, t.start_areas, t.ref_attrs) %}
            {% endcall %}
        {% else %}
            {% call start_area(t, t.start_areas, t.attrs) %}
            {% endcall %}
        {% endif %}

    {%- elif t.collapse_area -%}
        <div class="{{ t.collapse_class }}" title="Click to expand / collapse"
             id="{{ t.id }}"
             t="{{ t.t }}"
             attrs="{{ t.attrs_str }}"
             data-area="{{ t.collapse_area }}">
            <span class="areatitle">{{ t.html|safe }}</span>
            <div class="readline {{ t.status }}" title="Click to mark this area as read"></div>
{#          <div class="areareadline {{ t.status }}" title="Click to mark this area as read"></div>#}
           {{ editline|safe }}
        </div>

    {%- else -%}
        <div class="{{[t.cls|trim, t.is_plugin|trim]|join(' ')|trim}}"
             id="{{ t.id }}"
             t="{{ t.t }}"
             attrs="{{ t.attrs_str }}"
         {% if t.ref_attrs and t.ref_attrs.classes and "deleted" in t.ref_attrs.classes %}
             title="This paragraph has been deleted from the source document."
         {% endif %}
         {% if area %}
             data-area="{{ area|safe }}"
         {% endif %}
         {% if t.ref_id %}
             ref-id="{{ t.ref_id }}"
             ref-t="{{ t.ref_t }}"
             ref-attrs="{{ t.ref_attrs_str }}"
             ref-doc-id="{{ t.ref_doc_id }}"
         {% endif %}
        {% if not t.is_plugin %}ng-non-bindable{% endif %}>
        {% set task_id = (t.ref_attrs or t.attrs)['taskId'] %}
            {%- if t.is_plugin and t.needs_browser and not preview -%}
                <answerbrowserlazy task-id="{{ (t.ref_doc_id or t.doc_id) }}.{{ task_id }}"></answerbrowserlazy>
            {%- endif -%}
        {%- if task_id and not preview -%}
            <a href="#{{ task_id }}" title="Permlink" class="headerlink">#</a>
        {%- endif -%}

        {%- if not t.html -%}
            {%- if t.md -%}
                <div class="parContent mdcontent"{% if task_id %} id="{{ task_id }}"{% endif %}>
                {{ t.md|escape }}
                </div>
            {%- elif t.attrs_str -%}
                <div class="parContent mdcontent"{% if task_id %} id="{{ task_id }}"{% endif %}>
                {{ t.attrs_str|escape }}
                </div>
            {%- else -%}
                <div class="parContent mdcontent"{% if task_id %} id="{{ task_id }}"{% endif %}>
                    (hidden paragraph)
                </div>
            {%- endif -%}
        {%- else -%}
            <div class="parContent"{% if task_id %} id="{{ task_id }}"{% endif %}>
                {{ t.html|safe }}
            </div>
        {%- endif -%}

        {%- if t.attrs.rl == 'force' or not (not t.attrs.rd or t.attrs.rl == 'no') -%}
            <a
            {% if t.ref_attrs and t.ref_attrs.classes and "deleted" in t.ref_attrs.classes %}
                class="parlink deleted"
            {% else %}
                class="parlink"
            {% endif %}
               href="/view/{{ t.ref_doc_id }}#{{ t.ref_id }}"
               data-docid="{{ t.ref_doc_id }}" data-parid="{{ t.ref_id }}">
                <sup>[*]</sup></a>
        {%- endif -%}

        {%- if t.attrs.area_end == area -%}
            {% set area = none %}
        {%- endif -%}

        {%- if area -%}
            <div class="areapartline"></div>
        {%- endif -%}

        {{ editline|safe }}
        {%- if not disable_read_markings -%}
            <div class="{{ ['readline', t.status|join(' ')]|join(' ')|trim }}"
                 title="Click to mark this paragraph as read"></div>
        {%- endif -%}

        {%- if t.notes -%}
            <div class="notes">
                {%- for note in t.notes -%}
                    <div class="{{ ['note', 'editable' if note.editable else '', 'private' if note.private else '']|join(' ')|trim }}"
                         note-id="{{ note.id }}">
                        {{ note.html|safe }}
                        &mdash;
                        {%- if item.rights.teacher %}
                            <a class="username" title="{{ note.real_name }}" href="mailto:{{ note.user_email }}"
                            >{{ note.user_name }}</a>
                        {%- endif %}
                        <span class="timestamp" title="{{ note.created }}">{{ note.created|datestr_to_relative }}</span>
                        {%- if note.modified -%}
                            <span class="timestamp" title="{{ note.modified }}">
                                (edited {{ note.modified|datestr_to_relative }})
                            </span>
                        {%- endif -%}
                    </div>
                {%- endfor -%}
            </div>
        {%- endif -%}
        </div>
    {%- endif -%}
{%- endfor -%}
