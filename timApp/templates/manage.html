{% extends "base.html" %}
{% block title %}Manage document{% endblock %}
{% block head %}
{{ super() }}
<script src="{{url_for('static', filename='scripts/manageView/manageCtrl.js')}}"></script>

<style type="text/css">
table {
	margin: 1em;
}

thead {
	font-weight: bold;
}

table td {
	padding: 0.2em;
}

.flashes li {
	list-style-type: none;
	border: 1px solid black;
	border-radius: 3px;
	padding: 0.5em;
}

.uploadForm {
	border: 1px solid black;
	padding: 1em;
}

.material {
	padding: 1em;
}

.margin {
	margin-top: 1em;
	margin-bottom: 1em;
}
</style>
<script>
var doc = {{doc|tojson|safe}};
var editors = {{editors|tojson|safe}};
var viewers = {{viewers|tojson|safe}};
</script>
{% endblock %}
{% block content %}
<div ng-app="permApp" ng-controller="PermCtrl">
    {% with messages = get_flashed_messages() %} {% if messages %}
    <ul class="flashes">
        {% for message in messages %}
        <li>{{ message }}</li> {% endfor %}
    </ul>
    {% endif %} {% endwith %}
        <div class="margin">
            <a href="/view/{{ '{{doc.id}}' }}">View this document</a> <br>
            <a href="/edit/{{ '{{doc.id}}' }}">Edit this document</a>
        </div>
        Document owner: {{ '{{ doc.owner.name }}' }}
        <div class="margin">
            Editors:
            <p ng-show="editors.length == 0">This document doesn't have editors.</p>
            <ul>
                <li ng-repeat="editor in editors">{{ '{{editor.name}}' }} (<a ng-click="removeConfirm(editor, 'edit')">remove</a>)
                </li>
            </ul>
            <button ng-show="!showAddEditor" ng-click="showAddEditor = true; focusEditor = true">Add editor</button>
            <div ng-show="showAddEditor">
                <form ng-submit="addPermission(editorName, 'edit')">
                    <label>Name: <input type="text" ng-model="editorName" focus-me="focusEditor"></label>
                    <input type="submit" value="Add" ng-disabled="!editorName">
                    <input type="button" value="Cancel" ng-click="showAddEditor = false">
                    <input type="button" value="Add all" ng-click="addPermission('all', 'edit')">
                </form>
            </div>
        </div>
        <div class="margin">
            Viewers:
            <p ng-show="viewers.length == 0">This document doesn't have viewers.</p>
            <ul>
                <li ng-repeat="viewer in viewers">{{ '{{viewer.name}}' }} (<a ng-click="removeConfirm(viewer, 'view')">remove</a>)
                </li>
            </ul>
            <button ng-show="!showAddViewer" ng-click="showAddViewer = true; focusViewer = true">Add viewer</button>
            <div ng-show="showAddViewer">
                <form ng-submit="addPermission(viewerName, 'view')">
                    <label>Name: <input type="text" ng-model="viewerName" focus-me="focusViewer"></label>
                    <input type="submit" value="Add" ng-disabled="!viewerName">
                    <input type="button" value="Cancel" ng-click="showAddViewer = false">
                    <input type="button" value="Add all" ng-click="addPermission('all', 'view')">
                </form>
            </div>
        </div>
        <form ng-submit="renameDocument(newName)">
            <label>Document name: <input type="text" ng-model="newName">
            </label>
            <input type="submit" value="Update" ng-disabled="newName === doc.name">
        </form>
        <form class="uploadForm margin">
            Upload a new version for this document
            <div>
                <input type="file" ng-model="fileName" ng-file-select="updateDocument(doc, $files)">
                <span ng-bind="progress"></span>
                <button id="reset" type="reset" value="Reset">Clear</button>
            </div>
        </form>
        <form class="uploadForm">
            Edit the full document
            <div>
                <textarea class="docEditor" ng-model="fulltext"></textarea>
                <button ng-disabled="(doc.fulltext === fulltext) || saving" ng-click="saveDocument(doc)">Save</button>
                <span ng-show="saving">Saving...</span>
            </div>
        </form>
        <a href="/download/{{ '{{ doc.id }}' }}">Download document markdown</a>
        <div class="margin">
            <button ng-click="deleteDocument(doc.id)">Delete document</button>
        </div>
        <p>Document version history</p>
        <table>
            <thead>
                <tr>
                    <td>Time</td>
                    <td>User</td>
                    <td>Difference</td>
                </tr>
            </thead>
            <tr ng-repeat="version in doc.versions">
                <td><a href="/download/{{ '{{ doc.id + "/" + version.hash }}' }}">{{ '{{ version.timestamp }}' }}</a></td>
                <td>{{ '{{ version.user }}' }}</td>
                <td><a href="/diff/{{ '{{ doc.id + "/" + version.hash }}' }}">{{ '{{ version.message }}' }}</a></td>
            </tr>
        </table>
        <a href="{{url_for('indexPage')}}">Return to the index page</a>
    </div>
{% endblock %}