{% extends "base.html" %}
{% block title %}{{ doc.name }}{% endblock %}
{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename='scripts/checkModules.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/marktree.js') }}"></script>

    {% if teacher_mode %}
        <script src="{{ url_for('bower.static', filename='ng-table/dist/ng-table.js') }}"></script>
        <script src="{{ url_for('bower.static', filename='ng-table-export/ng-table-export.js') }}"></script>
        <script src="{{ url_for('static', filename='scripts/ng-table-exportKorppi.js') }}"></script>
        {#        <link rel="stylesheet" href="{{ url_for('bower.static', filename='ng-table/dist/ng-table.css') }}">#}
    {% endif %}

    {% for script in js %}
        <script src=" {{ script }}"></script>
    {% endfor %}
    <script>
        var modules = checkModules([
            {% for dep in jsMods %}
                "{{ dep|safe}}",
            {% endfor %}
            {% if teacher_mode %}
                "ngTable", "ngTableExport", "ngTableExportKorppi"
            {% endif %}
        ]);

    </script>

    {% include 'view_head.html' %}
    {% include 'common_head.html' %}

    {% if teacher_mode %}
        <script src="{{ url_for('static', filename='scripts/userlistController.js') }}"></script>
    {% endif %}

    {% if in_lecture or lecture_mode %}
        {% include 'lecture_head.html' %}
    {% endif %}

    {% for cssFile in cssFiles %}
        <link rel="stylesheet" href="{{ cssFile }}">
    {% endfor %}

    {% for cssFile in custom_css_files %}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/' + cssFile + '.css') }}">
    {% endfor %}

    {{ (doc_css | safe ) if doc_css }}
    <style type="text/css">
        {{ custom_css if custom_css }}
    </style>
    <script>
        var docId = JSON.parse({{doc.id|tojson|safe}});
        var docName = {{doc.fullname|tojson|safe}};
        var version = {{version|tojson|safe}};
        var rights = {{rights|tojson}};
        var reqs = {{reqs|tojson}};
        var startIndex = {{start_index|tojson}};
        var refererPath = {{request.path|tojson|safe}};
        var teacherMode = {{teacher_mode|tojson}};
        var group = {{group|tojson}};
        var lectureMode = {{lecture_mode|tojson}};
        var in_lecture = {{in_lecture|tojson}};
        var users;
        {% if teacher_mode %}
            users = {{plugin_users|tojson}};
        {% else %}
            users = [{{current_user|tojson}}];
        {% endif %}

        var crumbs = getBreadcrumbs(docName);
        {% include 'breadcrumbs.js' %}
    </script>

{% endblock %}
{% block content %}
    <div ng-app="timApp" class="paragraphs" ng-controller="ViewCtrl">
        <div ng-cloak="" class="dialog" caption="Refresh the page?" tim-draggable-fixed="" ng-show="isPageDirty() && !hideRefresh">
            <p>The page has been modified since the last reload. Refresh now?</p>
            <button ng-click="reload()">Refresh</button>
            <button ng-click="closeRefreshDlg()">No</button>
        </div>
        {% raw %}
        <div ng-cloak="" class="dialog" caption="Updates pending" tim-draggable-fixed="" ng-show="showUpdateDialog()">
            <p>There are {{ pendingUpdatesCount() }} pending paragraph updates.</p>
            <button ng-click="updatePending()">Update</button>
            <button ng-click="hidePending = true">Dismiss</button>
        </div>
        {% endraw %}
        {% include 'breadcrumbs.html' %}

        {% if lecture_mode or in_lecture %}
            {% include 'lecture.html' %}
        {% else %}
            {% include 'side_menu.html' %}
        {% endif %}

        {% if teacher_mode %}
            <div ng-controller="UserListController" id="users" class="userlist" tim-draggable-fixed caption="Users">
                {% if plugin_users %}
                    Users with answers ({{ plugin_users|length }}):<br>
                    {% raw %}
                    <table ng-table="tableParams" show-filter="true" class="table ng-table-rowselected"
                           export-csv="csv" export-korppi="expkorppi">
                        <tr ng-repeat="user in $data"
                            ng-click="changeUser(user)"
                            ng-class="{'active': user == selectedUser}">
                            <td data-title="'Full name'" sortable="'real_name'" filter="{ 'real_name': 'text' }">
                                {{user.real_name}}
                            </td>
                            <td data-title="'User name'" sortable="'name'" filter="{ 'name': 'text' }">
                                {{user.name}}
                            </td>
                            <td data-title="'Tasks'" sortable="'task_count'" filter="{ 'task_count': 'text' }">
                                {{user.task_count}}
                            </td>
                            <td data-title="'Total points'" sortable="'total_points'"
                                filter="{ 'total_points': 'text' }">
                                {{user.total_points}}
                            </td>
                        </tr>
                    </table>
                    <a ng-mousedown="csv.generate()" ng-href="{{ csv.link() }}" download="users_{{ doc.id }}.csv">Export
                        to CSV</a>
                    &nbsp;&nbsp;
                    <input type="text" size="5" name="korppiExportId" ng-model="expkorppi.korppiExportId">
                    <a ng-mousedown="expkorppi.generate()" ng-href="{{ expkorppi.link() }}" download="{{ expkorppi.korppiExportId }}.txt">Korppi</a>
                    {% endraw %}
                {% else %}
                    No answerers.
                {% endif %}
            </div>
        {% endif %}
        {% if slide_mode %}
            <div class="paragraphs">
                <iframe id="slideFrame" src="/show_slide/{{ doc.fullname }}" allowfullscreen></iframe>
            </div>
        {% else %}
            {% include 'view_content.html' %}
        {% endif %}
    </div>
    <p id="test"></p>

{% endblock %}
