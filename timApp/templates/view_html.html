{% extends "document.html" %}
{% block ngmodules %}
    {{ super() }}
    {% if teacher_mode %}
    {{ (['oc.lazyLoad', 'ui.ace', 'ngStorage', "ngTable", "ngTableExport", "ngTableExportKorppi"] + jsMods)|map('map_format', "'%s'")|join(', ')|safe }},
    {% else %}
    {{ (['oc.lazyLoad', 'ui.ace', 'ngStorage'] + jsMods)|map('map_format', "'%s'")|join(', ')|safe }},
    {% endif %}
{% endblock %}
{% block ngscripts %}
    {{ super() }}
    <script src="{{ url_for('bower.static', filename='oclazyload/dist/ocLazyLoad.min.js') }}"></script>
    {% if teacher_mode %}
        <script src="{{ url_for('bower.static', filename='ng-table/dist/ng-table.js') }}"></script>
        <script src="{{ url_for('bower.static', filename='ng-table-export/ng-table-export.js') }}"></script>
        <script src="{{ url_for('static', filename='scripts/ng-table-exportKorppi.js') }}"></script>
    {% endif %}

    {% for script in js %}
        <script src=" {{ script }}"></script>
    {% endfor %}
{% endblock %}

{% set teacher_mode = route in ("teacher", "answers") %}
{% set lecture_mode = route == "lecture" %}
{% set slide_mode = route == "slide" %}

{% set par_edit_mode = edit_mode == "par" %}
{% set area_edit_mode = edit_mode == "area" %}

{% block title %}{{ doc.title }}{% endblock %}

{# The custom style should be the last style element, so don't render it in base.html #}
{% block customcss %}{% endblock %}

{% block head %}
    {{ super() }}

    <script src="{{ url_for('static', filename='scripts/marktree.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/editmode.js') }}"></script>

    {% include 'view_head.html' %}

    {% if teacher_mode %}
        <script src="{{ url_for('static', filename='scripts/userlistController.js') }}"></script>
    {% endif %}

    {% for cssFile in cssFiles %}
        <link rel="stylesheet" href="{{ cssFile }}">
    {% endfor %}

    {# without this, lazy loading embedded_sagecell won't work because it doesn't know URL root #}
    <link property="sagecell-root" href="//sagecell.sagemath.org/"/>

    {% block viewhtml_customcss %}
        {% include 'doc_customcss.html' %}
    {% endblock %}

    <script>
        var noBrowser = {{ no_browser|tojson }};
        var showIndex = {{(headers|length > 0)|tojson}};
        var version = {{version|tojson}};
        var translations = {{translations|tojson}};
        var reqs = {{reqs|tojson}};
        var startIndex = {{start_index|tojson}};
        var refererPath = {{request.path|tojson}};
        var teacherMode = {{teacher_mode|tojson}};
        var group = {{group|tojson}};
        var lectureMode = {{lecture_mode|tojson}};
        var in_lecture = {{in_lecture|tojson}};
        var users;
        {% if teacher_mode %}
            users = {{plugin_users|tojson}};
        {% else %}
            users = [{{current_user|tojson}}];
        {% endif %}
        {% if lecture_mode or in_lecture %}
            var noQuestionAutoNumbering = {{ no_question_auto_numbering|tojson}};
        {% endif %}

    </script>
{% endblock %}

{% set col_1_lg = 2 %}
{% set col_2_lg = 7 %}
{% set col_3_lg = 3 %}

{% set col_1_md = 2 %}
{% set col_2_md = 7 %}
{% set col_3_md = 3 %}

{% set col_1_sm = 0 %}
{% set col_2_sm = 12 %}
{% set col_3_sm = 0 %}

{% block mainctrl %}ng-controller="ViewCtrl"{% endblock %}

{% block rightside %}
    {% if teacher_mode %}
        <div ng-controller="UserListController" id="users" class="userlist" tim-draggable-fixed caption="Users with answers ({{ plugin_users|length }})">
            {% if plugin_users %}
                {% raw %}
                <table ng-table="tableParams" show-filter="true" class="table table-condensed ng-table-rowselected"
                       export-csv="csv" export-korppi="expkorppi">
                    <tr ng-repeat="user in $data"
                        ng-click="changeUser(user)"
                        ng-class="{'active': user == selectedUser}">
                        <td ng-attr-title="{{user.real_name}}" data-title="'Full name'" sortable="'real_name'" filter="{ 'real_name': 'text' }">
                            {{user.real_name}}
                        </td>
                        <td ng-attr-title="{{user.name}}" data-title="'User name'" sortable="'name'" filter="{ 'name': 'text' }">
                            {{user.name}}
                        </td>
                        <td data-title="'Tasks'" sortable="'task_count'" filter="{ 'task_count': 'text' }">
                            {{user.task_count}}
                        </td>
                        <td data-title="'Total points'" sortable="'total_points'"
                            filter="{ 'total_points': 'text' }">
                            {{user.total_points}}
                        </td>
                    </tr>
                </table>
                <form>
                    <div class="form-group">
                        <a class="timButton btn-sm" ng-mousedown="csv.generate()" ng-href="{{ csv.link() }}"
                           download="users_{{ doc.id }}.csv">Export
                            to CSV</a>
                    </div>

                    <div class="form-group">
                        <div class="input-group input-group-sm">
                            <input placeholder="Korppi field name" class="form-control" type="text" size="5"
                                   name="korppiExportId" ng-model="expkorppi.korppiExportId">
                  <span class="input-group-btn">
                    <a class="timButton" ng-mousedown="expkorppi.generate()" ng-href="{{ expkorppi.link() }}"
                       download="{{ expkorppi.korppiExportId }}.txt">Export to Korppi</a>
                </span>
                        </div>
                    </div>
                </form>
                {% endraw %}
            {% else %}
                No answerers.
            {% endif %}
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <form name="ignore_me">
        <input type="hidden" id="page_is_dirty" name="page_is_dirty" value="0"/>
    </form>
    <div class="paragraphs">
        <div ng-cloak="" class="dialog" caption="Refresh the page?" tim-draggable-fixed="" ng-show="isPageDirty() && !hideRefresh">
            <p>The page has been modified since the last reload. Refresh now?</p>
            <button class="timButton" ng-click="reload()">Refresh</button>
            <button class="timButton" ng-click="closeRefreshDlg()">No</button>
        </div>
        {% if message %}
            <div ng-cloak="" class="dialog" caption="" tim-draggable-fixed="" ng-show="!hideMessage">
                <p>{{ message }}</p>
                <button class="timButton" ng-click="closeMessageDlg()">Ok</button>
            </div>
        {% endif %}
        {% raw %}
        <div ng-cloak="" class="dialog" caption="Updates pending" tim-draggable-fixed="" ng-show="showUpdateDialog()">
            <p>There are {{ pendingUpdatesCount() }} pending paragraph updates.</p>
            <button class="timButton" ng-click="updatePending()">Update</button>
            <button class="timButton" ng-click="hidePending = true">Dismiss</button>
        </div>
        {% endraw %}
        {% if task_info and task_info.total_points %}
            <div class="taskSummary">
                <span> 
                <strong>Task Summary</strong> 
                Total points: {{ task_info.total_points }},
                total tasks: {{ task_info.tasks_done }} / {{ task_info.total_tasks }}
                </span>
                <span class="smallNote" ng-click="reload()">Refresh (F5) to recount</span>
            </div>
            <div class="taskSmallSummary"><p>{{ task_info.total_points }} p</p></div>
        {% endif %}
        {% if slide_mode %}
            <div class="paragraphs">
                <iframe id="slideFrame" src="/show_slide/{{ doc.fullname }}" allowfullscreen></iframe>
                <a id="showSlidesLink" href="/show_slide/{{ doc.fullname }}">Show slides only</a>
            </div>
        {% else %}
            {% include 'view_content.html' %}
        {% endif %}
    </div>
    <p id="test"></p>

{% endblock %}
