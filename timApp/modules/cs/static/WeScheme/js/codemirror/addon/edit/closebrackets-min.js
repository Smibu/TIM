(function(f){"object"==typeof exports&&"object"==typeof module?f(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],f):f(CodeMirror)})(function(f){function o(b,a){return"pairs"==a&&"string"==typeof b?b:"object"==typeof b&&null!=b[a]?b[a]:s[a]}function v(b){return function(a){return w(a,b)}}function r(b){var a=b.state.closeBrackets;return!a||a.override?a:b.getModeAt(b.getCursor()).closeBrackets||a}function w(b,a){var c=r(b);if(!c||b.getOption("disableInput"))return f.Pass;
var e=o(c,"pairs"),d=e.indexOf(a);if(-1==d)return f.Pass;for(var c=o(c,"triples"),p=e.charAt(d+1)==a,t=b.listSelections(),k=0==d%2,j,m=0;m<t.length;m++){var h=t[m],g=h.head,q=b.getRange(g,i(g.line,g.ch+1));if(k&&!h.empty())h="surround";else if((p||!k)&&q==a)h=p&&x(b,g)?"both":0<=c.indexOf(a)&&b.getRange(g,i(g.line,g.ch+3))==a+a+a?"skipThree":"skip";else if(p&&1<g.ch&&0<=c.indexOf(a)&&b.getRange(i(g.line,g.ch-2),g)==a+a&&(2>=g.ch||b.getRange(i(g.line,g.ch-3),i(g.line,g.ch-2))!=a))h="addFour";else if(p)if(!f.isWordChar(q)&&
y(b,g,a))h="both";else return f.Pass;else if(k&&(b.getLine(g.line).length==g.ch||z(q,e)||/\s/.test(q)))h="both";else return f.Pass;if(j){if(j!=h)return f.Pass}else j=h}var l=d%2?e.charAt(d-1):a,n=d%2?a:e.charAt(d+1);b.operation(function(){if("skip"==j)b.execCommand("goCharRight");else if("skipThree"==j)for(var a=0;3>a;a++)b.execCommand("goCharRight");else if("surround"==j){for(var c=b.getSelections(),a=0;a<c.length;a++)c[a]=l+c[a]+n;b.replaceSelections(c,"around");c=b.listSelections().slice();for(a=
0;a<c.length;a++){var e=c,g=a,d;d=c[a];var h=0<f.cmpPos(d.anchor,d.head);d={anchor:new i(d.anchor.line,d.anchor.ch+(h?-1:1)),head:new i(d.head.line,d.head.ch+(h?1:-1))};e[g]=d}b.setSelections(c)}else"both"==j?(b.replaceSelection(l+n,null),b.triggerElectric(l+n),b.execCommand("goCharLeft")):"addFour"==j&&(b.replaceSelection(l+l+l+l,"before"),b.execCommand("goCharRight"))})}function z(b,a){var c=a.lastIndexOf(b);return-1<c&&1==c%2}function u(b,a){var c=b.getRange(i(a.line,a.ch-1),i(a.line,a.ch+1));
return 2==c.length?c:null}function y(b,a,c){var e=b.getLine(a.line),d=b.getTokenAt(a);if(/\bstring2?\b/.test(d.type))return!1;c=new f.StringStream(e.slice(0,a.ch)+c+e.slice(a.ch),4);for(c.pos=c.start=d.start;;){e=b.getMode().token(c,d.state);if(c.pos>=a.ch+1)return/\bstring2?\b/.test(e);c.start=c.pos}}function x(b,a){var c=b.getTokenAt(i(a.line,a.ch+1));return/\bstring/.test(c.type)&&c.start==a.ch}var s={pairs:"()[]{}''\"\"",triples:"",explode:"[]{}"},i=f.Pos;f.defineOption("autoCloseBrackets",!1,
function(b,a,c){c&&c!=f.Init&&(b.removeKeyMap(m),b.state.closeBrackets=null);a&&(b.state.closeBrackets=a,b.addKeyMap(m))});for(var n=s.pairs+"`",m={Backspace:function(b){var a=r(b);if(!a||b.getOption("disableInput"))return f.Pass;for(var c=o(a,"pairs"),a=b.listSelections(),e=0;e<a.length;e++){if(!a[e].empty())return f.Pass;var d=u(b,a[e].head);if(!d||0!=c.indexOf(d)%2)return f.Pass}for(e=a.length-1;0<=e;e--)c=a[e].head,b.replaceRange("",i(c.line,c.ch-1),i(c.line,c.ch+1),"+delete")},Enter:function(b){var a=
r(b),a=a&&o(a,"explode");if(!a||b.getOption("disableInput"))return f.Pass;for(var c=b.listSelections(),e=0;e<c.length;e++){if(!c[e].empty())return f.Pass;var d=u(b,c[e].head);if(!d||0!=a.indexOf(d)%2)return f.Pass}b.operation(function(){b.replaceSelection("\n\n",null);b.execCommand("goCharLeft");c=b.listSelections();for(var a=0;a<c.length;a++){var d=c[a].head.line;b.indentLine(d,null,!0);b.indentLine(d+1,null,!0)}})}},k=0;k<n.length;k++)m["'"+n.charAt(k)+"'"]=v(n.charAt(k))});
