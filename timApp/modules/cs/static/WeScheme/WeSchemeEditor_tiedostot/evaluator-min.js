var Evaluator=function(){var e=function(a){var c=this;this.write=a.write?a.write:function(){};this.compilationServletUrl=a.compilationServletUrl?a.compilationServletUrl:"/servlets/standalone.ss";this.transformDom=a.transformDom?a.transformDom:function(a){if(helpers.isLocationDom(a)){for(var b=a,a=document.createElement("span"),b=b.children,c,i,g,e=0;e<b.length;e++)"location-id"===b[e].className&&(g=b[e].textContent),"location-line"===b[e].className&&(c=b[e].textContent),"location-column"===b[e].className&&
(i=b[e].textContent);a.appendChild(document.createElement("br"));a.appendChild(document.createTextNode("at line: "+c+", column: "+i+", in "+g))}return a};this.aState=new state.State;this.aState.setPrintHook(function(a){a=types.toDomNode(a);a=c.transformDom(a);c.write(a);helpers.maybeCallAfterAttach(a)});this.aState.setDisplayHook(function(a){var b=document.createElement("span");b.style.whiteSpace="pre-wrap";b.style.fontFamily="monospace";a=a.split("\n").filter(function(a){return""!==a});0<a.length&&
b.appendChild(document.createTextNode(a[0]));var f;for(f=1;f<a.length;f++)newline=document.createElement("br"),newline.style.clear="left",newline.className="value-seperator",b.appendChild(newline),b.appendChild(document.createTextNode(a[f]));b=c.transformDom(b);c.write(b);helpers.maybeCallAfterAttach(b)});this.aState.setToplevelNodeHook(function(){return c.makeToplevelNode()});this.aState.hooks.dynamicModuleLoader=function(a,b,f){c.dynamicModuleLoader(a,b,f)};this.dynamicModuleLoader=function(a,b,
f){l(c.rootLibraryPath+"/"+a+".js?__gensym="+encodeURIComponent(""+Math.random()),b,f)};this.rootLibraryPath="/collects"};e.prototype.setImageProxy=function(a){this.aState.setImageProxyHook(a)};e.prototype.setRootLibraryPath=function(a){this.rootLibraryPath=a};e.prototype.setDynamicModuleLoader=function(a){this.dynamicModuleLoader=a};e.prototype.makeToplevelNode=function(){var a=document.createElement("div"),c=document.createElement("div");c.appendChild(a);this.write(c);helpers.maybeCallAfterAttach(c);
return a};e.prototype.requestBreak=function(){this.aState.requestBreak()};e.prototype.executeProgram=function(a,c,d,b){var f=this;this.compileProgram(a,c,function(a){a=JSON.parse(a);f._onCompilationSuccess((0,eval)("("+a.bytecode+")"),d,b)},function(a){f._onCompilationFailure(JSON.parse(a||'""'),b)})};e.prototype.setCompileProgram=function(a){this.compileProgram=a};e.prototype.compileProgram=function(a,c,d,b){var f=this,e=m({name:a,program:c,format:"json","compiler-version":"1"}),g=new XMLHttpRequest;
g.onreadystatechange=function(){4==g.readyState&&(503==g.status?f.compileProgram(a,c,d,b):200===g.status?d(g.responseText):b(g.responseText))};g.open("POST",this.compilationServletUrl,!0);g.setRequestHeader("Content-type","application/x-www-form-urlencoded");g.send(e)};e.prototype.executeCompiledProgram=function(a,c,d){this.aState.clearForEval();try{interpret.load(a,this.aState)}catch(b){d(b);return}interpret.run(this.aState,c,d)};var n={}.hasOwnProperty,m=function(a){var c=[],d;for(d in a)n.call(a,
d)&&c.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d]));return c.join("&")};e.prototype.getTraceFromExn=function(a){if(types.isSchemeError(a)){if(a=a.val,types.isExn(a)&&types.exnContMarks(a))return a=types.exnContMarks(a),state.getStackTraceFromContinuationMarks(a)}else if(types.isInternalError(a))return state.getStackTraceFromContinuationMarks(a.contMarks);return[]};e.prototype.getMessageFromExn=function(a){if("undefined"===typeof a)return"internal undefined error";return types.isSchemeError(a)?
(a=a.val,types.isExn(a)?types.exnMessage(a):a+""):types.isInternalError(a)?a.val+"":a.nodeType?a:a.message};e.prototype._onCompilationSuccess=function(a,c,d){this.executeCompiledProgram(a,c,d)};e.prototype._onCompilationFailure=function(a,c){"string"===typeof a?c(Error(a)):"object"===typeof a?c(this._convertErrorValue(a)):c(Error(a))};e.prototype._convertErrorValue=function(a){return a.type&&"exn:fail:read"===a.type?Error(a.message):a.type&&"moby-failure"===a.type?new o(this._convertDomSexpr(a["dom-message"]),
a["structured-error"]):Error(a+"")};var h=function(a){return types.vector([a.id,parseInt(a.offset),parseInt(a.line),parseInt(a.column),parseInt(a.span)])},k=function(a){var c=[],d;for(d=0;d<a.length;d++)c.push(h(a[d]));return c},k=function(a){var c=[],d;for(d=0;d<a.length;d++)c.push(h(a[d]));return c},o=function(a,c){this.message=a.textContent||a.innerText||a;this.domMessage=a;if(c){this.structuredError=JSON.parse(c);var d=this.structuredError.message,b=[],f;for(f=0;f<d.length;f++)if("string"===typeof d[f])b.push(d[f]);
else if("ColoredPart"===d[f].type)b.push(new types.ColoredPart(d[f].text,h(d[f].loc)));else if("GradientPart"===d[f].type){var e,g=[];for(e=0;e<d[f].parts.length;e++){var j=d[f].parts[e];g.push(new types.ColoredPart(j.text,h(j.loc)))}b.push(new types.GradientPart(g))}else"MultiPart"===d[f].type?b.push(new types.MultiPart(d[f].text,k(d[f].locs),d[f].solid)):b.push(d[f]+"");this.message=(new types.Message(b)).toString()}else this.structuredError=void 0};e.prototype._convertDomSexpr=function(a){if("number"===
typeof a||"string"===typeof a){var c=document.createElement("span");c.appendChild(document.createTextNode(a+""));return c}if("object"===typeof a){for(var c=document.createElement(a[0]),d=a[1],b=0;b<d.length;b++)"style"===d[b][0]?c.style.cssText=d[b][1]:"class"===d[b][0]?c.className=d[b][1]:c[d[b][0]]=d[b][1];a=a.splice(2);for(b=0;b<a.length;b++)c.appendChild(this._convertDomSexpr(a[b]));return this.transformDom(c)}return a};var l=function(a,c,d){var b=arguments.callee;"queue"in b||(b.queue={});var f=
b.queue;if(a in f)c&&(f[a]?f[a].push(c):c());else{f[a]=c?[c]:[];var e=document.createElement("script");e.type="text/javascript";e.onload=e.onreadystatechange=function(){if(!e.readyState||!("loaded"!=e.readyState&&"complete"!=e.readyState)){e.onreadystatechange=e.onload=null;document.getElementsByTagName("head")[0].removeChild(e);var b=f[a];for(delete f[a];b.length;)b.shift()()}};e.onerror=function(){e.onreadystatechange=e.onload=null;document.getElementsByTagName("head")[0].removeChild(e);d()};e.src=
a;document.getElementsByTagName("head")[0].appendChild(e)}};return e}();
