# Aloitetaan ubuntun imagesta
from ubuntu:16.04
maintainer vesal "vesal@jyu.fi"

# Workaround PAM: system error -messagelle
run ln -fs /bin/true /usr/bin/chfn

# Aikavyöhyke ja merkistöt kuntoon
run locale-gen en_US.UTF-8
env LANG en_US.UTF-8
env LANGUAGE en_US:en
env LC_ALL en_US.UTF-8
run echo "Europe/Helsinki" > /etc/timezone; dpkg-reconfigure -f noninteractive tzdata

# tuntuu valittavan koko ajan jos ei tätä asenna
run apt-get update
run apt-get install -y apt-utils

# Asennetaan python, pip ja flask 

run apt-get update
run apt-get install -y python3
run apt-get install -y python3-pip
run pip3 install bleach
run apt-get update
RUN apt-get install -y --fix-missing
run apt-get install -y libsdl1.2debian
run apt-get install -y libsdl-mixer1.2
run apt-get install -y xvfb
# run apt-get install -y python  
run apt-get install -y imagemagick
run apt-get install -y openjdk-8-jre-headless
run apt-get install -y wget
run locale-gen en_US.UTF-8 
run locale-gen fi_FI.UTF-8 

# Poistetaan pip. Sitä ei tarvitse enää ja saadaan
# hitusen pienempi image ja vähemmän ohjelmia potentiaalisen
# hyökkääjän käyttöön. (Periaate ok. käytännössä tosi marginaalinen
# toimenpide)
# run apt-get -y --purge remove python3-pip

# Lisätään alkuperäinen hakemisto polkuun /service
run mkdir /service

# Get GPG keys for Java 8
# run sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 40976EAF437D05B5
run apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 40976EAF437D05B5

# Define working directory.
#WORKDIR /data

# Define commonly used JAVA_HOME variable
# ENV JAVA_HOME /usr/lib/jvm/java-8-oracle


# Configure timezone and locale
RUN echo "Europe/Helsinki" > /etc/timezone; dpkg-reconfigure -f noninteractive tzdata
# run locale-gen C.UTF-8 
#env LC_CTYPE C.UTF-8
#env LC_ALL C.UTF-8 
env LC_CTYPE en_US.UTF-8
env LC_ALL en_US.UTF-8
env LANG en_US.UTF-8
env LANGUAGE en_US.UTF-8

# Install Docker client binary
run wget -q https://get.docker.com/builds/Linux/x86_64/docker-1.10.2.tgz && \
    tar -xzvf docker-1.10.2.tgz && \
    rm docker-1.10.2.tgz

# Python packages

#run pip3 install numpy
#run pip3 install scipy
#run pip3 install scikit-learn
#run pip3 install matplotlib
#run pip3 install statsmodels
#run pip3 install pandas
# http://www.scipy.org/install.html
# sudo apt-get install python-numpy python-scipy python-matplotlib ipython ipython-notebook python-pandas python-sympy python-nose
#run apt-get install -y python3-numpy python3-scipy python3-matplotlib python3-pandas
#run pip3 install statsmodels

# Octave
#run apt-add-repository ppa:octave/stable
#run apt-get update

RUN apt-get update
RUN apt-get install -y --fix-missing

RUN apt-get build-dep -y octave

ENV DISPLAY :0

# Change work directory to build Octave 4.2.1 from source
WORKDIR /tmp

RUN wget https://ftp.gnu.org/gnu/octave/octave-4.2.1.tar.gz && \
  tar -xvf octave-4.2.1.tar.gz && \
  rm octave-4.2.1.tar.gz && \
  cd octave-4.2.1 && \
  /tmp/octave-4.2.1/configure
RUN  cd octave-4.2.1 && make -j4
RUN  cd octave-4.2.1 && make install
RUN  rm -rf /tmp/*

WORKDIR /data

# run apt-get install -y octave less
#run add-apt-repository ppa:octave/stable
#run apt-get update


#run apt-get install -y epstool
#run apt-get install -y transfig


#run apt-get install -y octave-control
#run apt-get install -y octave-io

#env LD_LIBRARY_PATH /usr/lib/jvm/java-8-oracle/jre/lib/amd64/server
# run javareconf
#run ln -s /usr/lib/jvm/java-8-oracle /usr/lib/jvm/default-java


# run apt-get install -y octave-signal
# run apt-get install -y octave-statistics
# run apt-get install -y octave-control octave-image octave-io octave-optim octave-signal octave-statistics


# run apt-get install -y lua5.2
    
# run apt-get install -y r-cran-mvtnorm


# Lisätään käyttäjä `agent` -- Emme halua ajaa containerissakaan
# palveluja roottina.
# run useradd -M agent 
run useradd -m agent
ENV HOME /home/agent
run mkdir -p /service
run chown -R agent /service

# run groupadd docker
#run gpasswd -a agent docker
#run usermod -a -G sudo agent

# testejä varten
ENV MYPASSWORD password
#RUN echo root:kissa | chpasswd
#RUN echo agent:kissa | chpasswd

# Varmuudeksi estetään root login ja poistetaan rootin salasana,
# jos sellainen on.
# run usermod -p '!' root
# run passwd -l root

#run chmod 777 /etc/ssh
#run chmod 777 /etc/ssh/*

# Laita seuraava kommentteihin tuotantoa varten
##run usermod -a -G sudo agent

# Asetetaan container käynnistymään tunnuksella agent.
user agent

# Avataan portti 5000 ulos containerista.
expose 5000

#volume /tim_files/:/service/tim_files/

