version: "3"
services:
 tim:
  depends_on:
   - postgresql-test
   - postgresql-tempdb-test
   - csplugin
   - pali
   - showfile
   - haskellplugins
   - imagex
   - uploader
   - chrome
   - dumbo
   - ts-watcher
   - funnel
  tmpfs:
   - /tmp
 postgresql-test:
  image: postgres:9.5
  tmpfs:
   - /var/lib/postgresql/data
 postgresql-tempdb-test:
  image: postgres:9.5
  tmpfs:
   - /var/lib/postgresql/data
 chrome:
  image: selenium/standalone-chrome:3.8.1
  tmpfs:
   - /tmp
   - /home/seluser
 nginx:
  image: timimages/local_nginx_dev:compose
  build:
   args:
    MAIN_CONFIG: tim_dev.conf
  ports:
   - "${NGINX_PORT}:80"
   - "81:81"
   - "82:82"
 ts-watcher:
  command: "sleep infinity"
 tests:
  image: timimages/tim:${TIM_IMAGE_TAG}
  command: "python3 -m unittest ${TEST_PARAMS:-discover tests/ 'test_*.py' .}"
  volumes:
   - .:/service:ro
   - ./screenshots:/service/screenshots:rw
   - ./timApp/static/testgen:/service/timApp/static/testgen:rw
   - ./timApp/static/.webassets-cache:/service/timApp/static/.webassets-cache:rw
   - ./timApp/static/scripts:/service/timApp/static/scripts:rw
  environment:
   TIM_SETTINGS: testconfig.py
   PYTHONPATH: /service
  depends_on:
   - nginx
  tmpfs:
   - /tmp/doctest_files
  working_dir: /service/timApp
