version: "3.7"
services:
 tim:
  image: timimages/tim:${TIM_IMAGE_TAG}
  build: ./timApp
  depends_on:
   # - stack-api-server
   - postgresql
   - csplugin
   - pali
   - fields
   - showfile
   - haskellplugins
   - imagex
   - uploader
   - dumbo
   - feedback
   - redis
  volumes:
   - .:/service
   - ${LOG_DIR}:/service/tim_logs
   - ${FILES_ROOT}:/tim_files
   - cache:/cache
  working_dir: /service/timApp
  command: python3 launch.py --with-gunicorn
  environment:
   FLASK_APP: tim.py
   PYTHONPATH: /service:/service/timApp/modules/py
   COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
   TIM_SETTINGS: ${CONFIG_FILE}
   TIM_HOST: ${TIM_HOST}
  restart: unless-stopped
  networks:
   - db
   - default
  read_only: true
  tmpfs:
   - /root
   - /tmp
   - /var/cache
   - /var/log
 timagent:
  image: timimages/timagent
  build:
   context: ./timApp
   dockerfile: DockerfileAgent
   args:
    TIM_IMAGE_TAG: ${TIM_IMAGE_TAG}
  command: sleep infinity
  restart: unless-stopped
  read_only: true
 postgresql:
  image: postgres:11
  volumes:
   - data11:/var/lib/postgresql/data
  command: postgres -c 'max_connections=200'
  restart: unless-stopped
  networks:
   - db
  read_only: true
  tmpfs:
   - /run/postgresql
   - /tmp
 csplugin:
  image: timimages/cs3:rust
  build: ./timApp/modules/cs
  volumes:
   - ${FILES_ROOT}/blocks/uploads:/uploads:ro
   - ./timApp/modules/cs:/cs
   - /var/run/docker.sock:/var/run/docker.sock
   - ./timApp/modules/cs/generated:/csgenerated
   - ./timApp/modules/cs/static:/csstatic:ro
   - ./timApp/modules/py:/py:ro
   - /tmp/${COMPOSE_PROJECT_NAME}_uhome:/tmp
  working_dir: /cs
  command: ./startPlugins.sh
  environment:
   PYTHONUNBUFFERED: "1"
   TIM_ROOT: ${TIM_ROOT}
   TIM_HOST: ${TIM_HOST}
   COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
  user: root  # We need access to Docker socket.
  restart: unless-stopped
  read_only: true
 haskellplugins:
  image: timimages/haskellplugins:latest
  build:
   context: ./timApp/modules/Haskell
   dockerfile: Dockerfile
  volumes:
   - ./timApp/modules/Haskell:/Haskell
  working_dir: /Haskell
  command: ./startAll.sh
  restart: unless-stopped
  read_only: true
 showfile:
  image: timimages/svn:bionic
  build: ./timApp/modules/svn
  volumes:
   - ./timApp/modules/svn:/svn:ro
   - ./timApp/modules/py:/py:ro
  working_dir: /svn
  command: ./startAll.sh
  restart: unless-stopped
  read_only: true
  tmpfs:
    - /tmp
 imagex:
  image: timimages/cs3:rust
  volumes:
   - ./timApp/modules/imagex:/imagex:ro
   - ./timApp/modules/py:/py:ro
  working_dir: /imagex
  command: ./startAll.sh
  restart: unless-stopped
  read_only: true
 pali:
  image: timimages/tim:${TIM_IMAGE_TAG}
  build: ./timApp/modules/pali
  volumes:
   - ./timApp/modules/pali:/pali:ro
   - ./timApp/modules/py:/py:ro
  working_dir: /pali
  environment:
    PYTHONPATH: /pali:/py
  command: ./startAll.sh
  restart: unless-stopped
  read_only: true
 fields:
  image: timimages/tim:${TIM_IMAGE_TAG}
  build: ./timApp/modules/fields
  volumes:
   - ./timApp/modules/fields:/fields:ro
   - ./timApp/modules/py:/py:ro
  working_dir: /fields
  environment:
   PYTHONPATH: /fields:/py
  command: ./startAll.sh
  restart: unless-stopped
  read_only: true
 jsrunner:
  image: timimages/tim:${TIM_IMAGE_TAG}
  #build: ./timApp/modules/multisave
  volumes:
   - ./timApp/modules/jsrunner:/timApp/modules/jsrunner:rw
   - ./timApp/static/scripts:/timApp/static/scripts:ro
  working_dir: /timApp/modules/jsrunner/server
  command: ./startAll.sh
  restart: unless-stopped
  read_only: true
  tmpfs:
   - /root/.npm
   - /root/.config
 drag:
  image: timimages/tim:${TIM_IMAGE_TAG}
  volumes:
   - ./timApp/modules/drag:/drag:ro
   - ./timApp/modules/py:/py:ro
  working_dir: /drag
  environment:
   PYTHONPATH: /drag:/py
  command: ./startAll.sh
  restart: unless-stopped
  read_only: true
 feedback:
  image: timimages/tim:${TIM_IMAGE_TAG}
  volumes:
   - ./timApp/modules/feedback:/feedback:ro
   - ./timApp/modules/py:/py:ro
  working_dir: /feedback
  environment:
   PYTHONPATH: /feedback:/py
  command: ./startAll.sh
  restart: unless-stopped
  read_only: true
 uploader:
  image: villet/uploaderplugin:13_10_16_15
  command: ${UPLOADER_COMMAND}
  restart: unless-stopped
  read_only: true
 nginx:
  image: timimages/local_nginx:compose
  build:
   context: ./local_nginx
  depends_on:
   - tim
   - jsrunner
  volumes:
   - ./timApp/modules/cs/static:/csstatic:ro
   - ./timApp/modules/cs/generated:/csgenerated:ro
   - ./timApp/static:/static:ro
  restart: unless-stopped
  read_only: true
  tmpfs:
   - /var/cache/nginx
   - /run
 dumbo:
  image: timimages/dumbo:${TIM_IMAGE_TAG}
  build:
   context: ./Dumbo
   dockerfile: Dockerfile
   args:
    TIM_IMAGE_TAG: ${TIM_IMAGE_TAG}
  command: ./Dumbo --port 5000 --cacheDir /dumbocache --tmpDir /dumbotmp
  working_dir: /Dumbo
  volumes:
   - ./Dumbo/cache:/dumbocache
   - ./Dumbo/tmp:/dumbotmp
  logging:
   driver: none
  restart: unless-stopped
  read_only: true
 redis:
  image: redis
  restart: unless-stopped
  read_only: true
 celery:
  image: timimages/tim:${TIM_IMAGE_TAG}
  command: celery -A timApp.tim_celery.celery worker -B --concurrency 4
  volumes:
   - .:/service
   - ${LOG_DIR}:/service/tim_logs
   - ${FILES_ROOT}:/tim_files
   - cache:/cache
  working_dir: /service/timApp
  depends_on:
   - postgresql
   - redis
  environment:
   FLASK_APP: tim.py
   PYTHONPATH: /service:/service/timApp/modules/py
   COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME}
   TIM_SETTINGS: ${CONFIG_FILE}
   TIM_HOST: ${TIM_HOST}
  restart: unless-stopped
  networks:
   - db
   - default
  read_only: true
  tmpfs:
   - /tmp
 stack-api-server:
  build: ./stack
  image: timimages/stack
  security_opt:
   - seccomp:unconfined
  volumes:
   - ./stack/plots:/var/data/api/stack/plots:rw
   - ./stack/plots:/var/www/html/plots:rw
   - ./stack/api/config.php.docker:/var/www/html/config.php:rw
   - ./stack/entrypoint_install_and_run.sh:/var/www/html/entrypoint_install_and_run.sh
   # - ./stack/cas/castext/jsxgraphapi.block.php:/var/www/html/stack/cas/castext/jsxgraph.block.php
  restart: unless-stopped
  environment:
   BROWSER_URL: ${BROWSER_URL}
volumes:
 data11:
 cache:
networks:
 db:
